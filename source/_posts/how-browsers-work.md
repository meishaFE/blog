---
title: How  browsers work
date: 2018-11-22 20:00:00
tags: 
- browsers
---

本文主要内容是加上自己理解翻译的how browsers work这篇文章（http://taligarsiel.com/Projects/howbrowserswork1.htm）
以及B站的一个视频（https://www.bilibili.com/video/av35265997/）

### 一：浏览器的主要功能

浏览器的主要功能：是通过服务器请求您选择的Web资源，并在浏览器窗口中显示。资源格式通常是HTML，但也包括PDF，图像等。资源的位置由用户使用URI（统一资源标识符）指定。

### 二：浏览器的高级结构
1.  用户界面 —— 包括地址栏，后退/前进按钮，书签菜单等。除了您看到所请求页面的主窗口外，其他的都属于浏览器界面。
2.  浏览器引擎 —— 进行查询和计算操作的引擎
3.  渲染引擎 —— 负责显示请求的内容。例如，如果请求的内容是HTML，则它负责解析HTML和CSS并在屏幕上显示解析的内容。
4.  网络 —— 用于网络请求，如HTTP请求。它具有独立于平台的界面以及每个平台的底层实现。
5.  UI后台 —— 用于绘制组合框和窗口等基本小部件。它公开了一个非平台特定的通用接口。它下面使用操作系统用户界面方法。
6.  JavaScript解释器 —— 用于解析和执行JavaScript代码。
7.  数据存储 —— 持久层，作用是浏览器保存硬盘上的各种数据，例如cookie / localStorage

值得注意的是：Chrome和大多数浏览器不同的是，它拥有多个独立的渲染引擎实例，每新开一个tab页面就会新增一个，即每个tab都是一个独立的进程。

![浏览器的主要组件](https://img-blog.csdnimg.cn/20181106111224438.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0VjaG82MDE=,size_16,color_FFFFFF,t_70)

### 三：渲染引擎
渲染引擎的作用即是：在浏览器窗口中显示用户所请求的内容
渲染引擎可以可以显示HTML / XML文档和图像或PDF，这里主要讨论的是css / html / 图像
渲染的基本流程：
![渲染的基本流程](https://img-blog.csdnimg.cn/20181106154226601.png)
渲染引擎首先将HTML文档并将标记转换为名为"content tree"的树的DOM节点。
它将解析外部CSS文件和样式元素。
样式信息与HTML中的可视化指令一起用于创建另一个tree - 渲染树（rendering tree）。

在构建渲染树之后，再进行“布局”。这意味着为每个节点提供它应该出现在屏幕上的确切坐标。

下一个阶段是 绘制 —— 遍历渲染树，并使用UI后台绘制每个节点。
这是一个渐进的过程，为了获得更好的用户体验，渲染引擎会尽快在页面上显示请求的内容。在开始构建和布局渲染树之前，它不会解析到所有HTML，而是会解析和显示部分内容，并同时处理其他的网络内容。

### 四：浏览器的解析和DOM树结构

解析是渲染引擎中非常重要的一个缓解，我们所说的解析文档 - 就是读懂我们写的代码并能使用它，解析的结果通常是可以表现文档结构的DOM Tree。

解析可以被分为两个子进程- 词汇分析和句法分析。

1. 词汇分析是将输入的内容拆解为“token”。这些“token”是语言词汇，是有效的构建模块集，在人类语言中这些token由词汇组成并可以通过该语言的字典查到。

2. 句法分析指的是一个句子语法规则的应用。

而解析器通常由两部分构成：
1. 分词器（tokenizer）负责将输入内容拆分为有效符号。
2. 而解析器（parser）则负责句法分析文档结构构建解析树。分词器知道如何去除像空格，换行符这样的无关字符。

解析的过程是重复进行的。通常，解析器会向分词器请求一个新的token，然后尝试将其与句法规则进行匹配。一旦匹配成功，一个与该token相一致的节点就会被添加到解析树中，然后解析器就会请求下一个token。
如果规则匹配失败，解析器会先在内部将这个失败的token存储起来，然后继续请求其他token，直到找到可以匹配所有内部存储token的规则为止。如果最后都没有找到这样的规则，那么解析器就会产生异常，这表示该文件无效并包含句法错误。

需要强调的是，解析树并非最终的输出结果，解析会在转换过程中使用，转换指的是：将输入的文档转换为另一种格式。编译就是个例子。编译器可以将源代码编译为机器代码，它首先将文件编译为解析树，然后再将其转换为机器代码文件。


### 五：解析器类型

解析器分为两种基本类型：自上而下的解析器和自下而上的解析器。

1.  自上而下的解析器会从词法的高层结构入手，并尝试从中找到匹配项。它会把"2 + 3" 当成一个表达式。接下来，它会把"2 + 3 - 1" 也看成一个表达式（这个过程也会匹配其他规则，只不过是从高层结构开始解析）。
2.  自下而上的解析器则从输入内容入手，并逐步将其转换为句法规则，从低层规则入手，直到在高层结构中找到相匹配的内容，这个操作会一直持续到输入内容的结尾。所匹配表达式的半成品会被暂存在解析栈中。


### 六：HTML解析器
HTML解析器负责解析HTML标记语言到解析树中。
HTML非常的仁慈，它允许用户忽略一些标签，比如有时可以省略标签的开头和结尾等，HTML会偷偷地帮用户加上。

HTML显示时主要使用的是：树构造算法
主要步骤如下：
创建解析器时，将先创建Document对象。
在DOM Tree 的构建阶段，将修改其根目录中包含Document的DOM树，并将元素添加到其中。
标记生成器发出的每个节点都将由树构造函数处理。
标签创建之后。除了将元素添加到DOM树之外，它还被push到一堆开放元素中。此堆栈用于纠正嵌套不匹配和未关闭的标记。
该算法也被描述为状态机。这些状态称为“插入模式”。
