---
title: TCP/IP 概述
date: 2019-08-11 09:00:00
author: Echo
tags:
  - TCP/IP
  - 计算机网络
---

# 前言

这篇博客实际上应该算是《图解 TCP/IP》这本书的读书笔记。
由于太久没有复习计算机网络的相关知识，很多细节都说不上来了，所以找了这本书重新巩固一下大体知识，细节知识打算在《TCP/IP 详解》这本书中学习。

<!-- more -->

这里主要介绍是以下几个部分：

### 1. OSI 参考模型及 TCP/IP 五层模型
### 2. IP 协议及其相关技术
### 3. TCP/UDP

# 一. OSI 参考模型及 TCP/IP 五层模型

OSI 参考模型对通信中必要的功能做了很好的归纳，下图展示了 OSI 参考模型中各个分层的主要作用：

<img src="https://lexiangla.com/assets/42c360c0bcd111e99e530a58ac130555" width="660px"></img>

上图只对 OSI 各层进行功能上的大概阐述，我们从最顶层——应用层开始介绍。整个过程以公司 A 和公司 B 的一次商业报价单发送为例子进行讲解。

## 1. 应用层
OSI参考模型中最靠近用户的一层，是为计算机用户提供应用接口，也为用户直接提供各种网络服务。我们常见应用层的网络服务协议有：HTTP，HTTPS，FTP，POP3、SMTP等。
实际公司A的老板就是我们所述的用户，而他要发送的商业报价单，就是应用层提供的一种网络服务，当然，老板也可以选择其他服务，比如说，发一份商业合同，发一份询价单，等等。

## 2. 表示层
表示层提供各种用于应用层数据的编码和转换功能,确保一个系统的应用层发送的数据能被另一个系统的应用层识别。如果必要，该层可提供一种标准表示形式，用于将计算机内部的多种数据格式转换成通信中采用的标准表示形式。数据压缩和加密也是表示层可提供的转换功能之一。
由于公司A和公司B是不同国家的公司，他们之间的商定统一用英语作为交流的语言，所以此时表示层（公司的文秘），就是将应用层的传递信息转翻译成英语。同时为了防止别的公司看到，公司A的人也会对这份报价单做一些加密的处理。这就是表示的作用，将应用层的数据转换翻译等。

## 3. 会话层
会话层就是负责建立、管理和终止表示层实体之间的通信会话。该层的通信由不同设备中的应用程序之间的服务请求和响应组成。
会话层的同事拿到表示层的同事转换后资料，（会话层的同事类似公司的外联部），会话层的同事那里可能会掌握本公司与其他好多公司的联系方式，这里公司就是实际传递过程中的实体。他们要管理本公司与外界好多公司的联系会话。当接收到表示层的数据后，会话层将会建立并记录本次会话，他首先要找到公司B的地址信息，然后将整份资料放进信封，并写上地址和联系方式。准备将资料寄出。等到确定公司B接收到此份报价单后，此次会话就算结束了，外联部的同事就会终止此次会话。

## 4. 传输层
传输层建立了主机端到端的链接，传输层的作用是为上层协议提供端到端的可靠和透明的数据传输服务，包括处理差错控制和流量控制等问题。该层向高层屏蔽了下层数据通信的细节，使高层用户看到的只是在两个传输实体间的一条主机到主机的、可由用户控制和设定的、可靠的数据通路。我们通常说的，TCP UDP就是在这一层。端口号既是这里的“端”。

## 5. 网络层
本层通过IP寻址来建立两个节点之间的连接，为源端的运输层送来的分组，选择合适的路由和交换节点，正确无误地按照地址传送给目的端的运输层。就是通常说的IP层。这一层就是我们经常说的IP协议层。IP协议是Internet的基础。
网络层就相当于快递公司庞大的快递网络，全国不同的集散中心，比如说，从深圳发往北京的顺丰快递（陆运为例啊，空运好像直接就飞到北京了），首先要到顺丰的深圳集散中心，从深圳集散中心再送到武汉集散中心，从武汉集散中心再寄到北京顺义集散中心。这个每个集散中心，就相当于网络中的一个IP节点。

## 6. 数据链路层
将比特组合成字节,再将字节组合成帧,使用链路层地址 (以太网使用MAC地址)来访问介质,并进行差错检测。
数据链路层又分为2个子层：逻辑链路控制子层（LLC）和媒体访问控制子层（MAC）。

MAC子层处理CSMA/CD算法、数据出错校验、成帧等；LLC子层定义了一些字段使上次协议能共享数据链路层。 在实际使用中，LLC子层并非必需的。

## 7. 物理层
实际最终信号的传输是通过物理层实现的。通过物理介质传输比特流。规定了电平、速度和电缆针脚。常用设备有（各种物理设备）集线器、中继器、调制解调器、网线、双绞线、同轴电缆。这些都是物理层的传输介质。
快递寄送过程中的交通工具，就相当于我们的物理层，例如汽车，火车，飞机，船。


**TCP/IP 五层协议和 OSI 的七层协议对应关系如下：**

<img src="https://lexiangla.com/assets/428c6142bcd111e9a5430a58ac131042"></img>



# 二. IP 协议及其相关技术

IP 协议是整个 TCP/IP 中非常重要的一个协议，主要负责将数据包发送给最终的目标计算机，位于网络层。

IP 地址（IPv4 地址），由 32 位正整数来表示，IP 地址由 `网络标识`和`主机标识`两部分组成。

## 1. IP 地址的分类

IP 地址分为四个级别，A / B / C / D 4 个类，基本结构如下图所示：
<img src="https://lexiangla.com/assets/427538d2bcd111e980c60a58ac1318a3"></img>

要注意的是：在分配 IP 地址时，要用比特位表示主机地址时，不可以全部为 0 或者全部为 1，因为全部为 0 只有在表示对应的网络地址或 IP 地址不可获知的情况下才使用，而全部为 1 的主机地址通常作为广播地址。

## 2. IPv4 结构

IPv4 的数据包基本结构如下图所示：
<img src="https://lexiangla.com/assets/427480b8bcd111e9990c0a58ac131042"></img>

可以看到 IPv4 数据包主要由两部分组成：`IP首部 / IP载荷`（即数据）。
而在 IP 首部中，有很多的信息：
1. **版本**： 该信息长度为`4bit`，表示标识 IP 首部的版本号，IPv4 的版本号即为 4， 所以在这个字段上的值也是 4，而 IP 其实是有很多版本的，不同的值表示不同的 IP 版本，比如我们知道的 IPv6 的版本号为 6。
2. **首部长度**（IHL - Internet Header Length）：长度为`4bit`，表示 IP 首部的大小，在表示 IP 首部的大小时，它的单位为 `4字节，即32bit`，即每个数值代表 4 字节，对于没有可选项的 IP 包，可选项一般设为`5`，也就是说，当没有可选项时，IP 包的首部长度为`5*4=20字节`。而 4bit 的取值范围为`0-15`，所以首部长度最大可以设为`15`，所以首部长度最大可以是`4*15=60字节`。
3. **区分服务**（TOS - Type Of Service）：长度为 8bit，用来表明服务质量。
4. **总长度**：表示 IP 数据包（IP 首部+数据部分）的长度，长度为`16bit`，所以 IP 数据包的最大长度为`2的16次方 = 65535字节`。
5. **标识**：长度为 16bit，用于分片重组，同一个分片的标识值相同，不同分片的标识值不同，但是如果分片的标识值相同，但是目标地址 / 源地址 / 协议不同的话，也是不同的分片。
6. **标志**：长度为 3bit，表示包被分片的相关信息。
7. **片偏移**：长度为 13bit，用来标识被分片的每一个分段相对于原始数据的位置。
8. **生存时间**：长度为 8bit，它最初的意思是以秒为单位记录当前包在网络上应该生存的时限，然后在实际中它指可以中转多少个路由器的意思，每经过一个路由器，TTL 会减少 1，直到变成 0 则丢弃该包。
9. **协议**：长度为`8bit`，表示的是 ip 包传输层的上层协议编号。
10. **首部校验和**：长度为`16bit`，该字段只校验数据报的首部，不校验数据部分，主要用来确保 IP 数据报不被破坏。
11. **源地址**：32bit，表示发送端 ip 地址。
12. **目标地址**：32bit，表示接收端 ip 地址。
13. **可选项**：长度可变，一般只在实验和诊断的时候使用。
14. **填充**：在有可选项的情况下，首部长度可能不是 32bit 的整数倍，所以通过向字段填充 0，调整为 32bit 的整数倍。
15. **数据**：存入数据。

## 3. IPv6

IPv6 是为了根本解决 IPv4 地址耗尽的问题而被标准化的网际协议。
IPv4 的地址长度一般为 4 个 8 位字节，即 32bit，而 IPv6 的地址长度是原来的 4 倍，即 128bit，一般写成 8 个 16 位字节。

IPv6 数据首部格式如下图所示：

<img src="https://lexiangla.com/assets/42868dd0bcd111e990ef0a58ac131042"></img>

1. **版本**：同 IPv4 的版本示意，这里的值为 6。
2. **通信量类**：相当于 IPv4 的 Type Of Service 字段。
3. **流标号**：长度为 20bit，暂未使用，准备用于服务质量控制，只有在流标号，源地址，目标地址完全一致时，才认为它们时一个流。
4. **有效载荷长度**：即数据包的数据部分的长度。
5. **下一个首部**：相当于 IPv4 中的协议字段，长度为 8bit，通常表示 IP 的上一层协议是 TCP 或 UDP。
6. **跳数限制**：长度为 8bit，和 IPv4 中的 TTL 含义相同，数据每经过一次路由器就减一，减到 0 丢弃。
7. **IPv6 扩展首部**：IPv6 的首部固定，无法将可选项加入其中，取而代之的是通过扩展首部对功能进行扩展。

## 4. IP 协议相关技术

1. **ARP ( Address Resolution Protocol )**：ARP 是以目标 IP 地址为线索，用来定位下一个应该接收数据分包的网络设备对应的 MAC 地址，如果目标主机不在同一个链路上时，可以通过 ARP 查找下一跳路由器的 MAC 地址。⚠️ARP 只适用于 IPv4，不可用于 IPv6，在 IPv6 中可以用 ICMPv6 代替。
2. **RARP ( Reverse Address Resolution Protocol )**：就是将 ARP 反过来，从 MAC 地址定位到 IP 地址的一种协议。
3. **ICMP**：确认 IP 包是否成功送达目标地址，通知在发送过程中 IP 包被废弃的具体原因，改善网络设置等。主要应用场景为：一个刚建立好的网络，我们需要验证该网络的设置是否正确，并且在网络遇到问题的时候立即制止，并报告出来。  
前面说到的 IPv6 中的 ARP 代替协议 `ICMPv6`，包含了 ARP，ICMP 的作用，在 IPv6 中，如果没有 ICMPv6，IPv6 就无法正常通信。
4. **DHCP ( Dynamic Host Configuration Protocol )**：动态主机配置协议，实现自动设置 IP 地址，统一管理 IP 地址分配，
5. **IP 隧道**：在如下图的一个网络环境里，网络 AB 使用 IPv6，中间位的 C 网络使用 ipv4，这样 AB 网络将无法直接通信，而 IP 隧道就是解决不同网络间正常通信的问题。
IP 隧道中可以将哪些从网络 A 发过来的 IPv6 包统合为一个数据，再为之追加一个 IPv4 的首部以后转发给网络 C。
本来紧跟 IP 网络首部的是 TCP 或 UDP 的首部，然而现在情况是 IP 首部的后面是 IPv6 首部。

<img src="https://lexiangla.com/assets/426832eabcd111e9942e0a58ac130d38"></img>

# 三. TCP/UDP
在TCP/IP中能够实现传输层功能的协议中，最具代表性的协议是TCP/UDP。
TCP提供可靠的通信传输，而UDP则常被用于让广播和细节控制交给应用的通行传输。
## 1. TCP 

TCP是`面向连接的`、`可靠`的流协议。（流指不间断的数据结构）,TCP提供可靠传输的方式是实行“顺序控制”或“重发控制”机制，还有流量控制、拥塞控制等功能。

TCP可以进行丢包时的重发控制，还可以对次序乱掉的分包进行顺序控制，TCP作为一种面向有连接的协议，只有在确认通信对端存在时才会发送数据，从而可以控制通信的流量，避免浪费。

TCP通过`校验和`、`序列号`、`确认应答`、`重发控制`、`连接管理`以及`窗口控制`等机制实现可靠性传输。

以下图表示TCP通过序列号与确认应答提高可靠性：

<img src="https://lexiangla.com/assets/42a14562bcd111e9bc1f0a58ac13095b"></img>

**1. ACK** —— 在TCP中，当发送端的数据到达接收主机时，接收端主机会返回一个已收到消息的通知，这个消息叫ACK（Positive Acknowledgement），TCP通过ACK实现可靠的数据传输，当发送端将数据发出之后等待对端的确认应答，如果有确认应答，说明数据已经成功到达对端，反之则说明数据丢失的可能性很大。
而如果在一定时间段内没有收到确认应答，发送端就可以认为数据以及丢失，并进行重发，这样的话即时发生了丢包，也仍然可以保证数据可以到达对端，实现数据的可靠传输。
如果出现了丢包的情况，源发送主机只要按照机制重发数据即可，但是对于目标主机来说，他会反复收到相同的数据，而为了对上层应用提供可靠的传输，必须放弃重复的数据包，所以这就有了序列号机制的出现。

**2. 序列号** —— 序列号是按照顺序给发送数据的每一个字节（8位字节）都标上编号，接收端查询接收数据TCP首部中的序列号和数据的长度，将自己下一步应该接收的序号作为ACK返回给发送端。
所以，通过序列号和ACK，TCP就可以实现可靠的数据传输。

而我们说到的重发超时是什么呢？
**3. 重发超时** —— 重发超时是指在重发数据之前，等待ACK到达的那个时间间隔，如果超过了这个时间仍未收到ACK，发送将进行数据重发。
而重发时间的确定是怎么来的呢？比较理想的是，找到一个最小时间，这个时间可以保证“确认应答一定能在这个时间内返回”，但是这个时间的长短应该随着数据包途经的网络环境不同而有所变化。

## 2. UDP
UDP是不具有可靠性的数据报协议。利用IP提供面向无连接的通信服务，并且它是将应用程序发来的数据在收到的那一刻立刻按照原样发送到网络上的一种机制。
换句话说，它将部分控制转移给应用程序去处理，自己只提供作为传输层协议的最基本功能。
在UDP的情况下，虽然可以保证发送消息的大小，但是却不能保证消息一定会到达，因此，应用有时会根据自己的需要进行重发处理。

由于UDP面向无连接，它可以随时的发送数据，所以经常用在下面几个方面：
* 包总量比较少的通信（DNS，SNMP等）
* 视频，音频等多媒体通信（即时通信）
* 广播通信（广播，多播）



以上就是个人认为这本书中比较重要的部分啦～，当然这本书其实还有很多其他的相关知识，由于篇幅有限就不赘述了。
《图解 TCP/IP》这本书其实比较适合快速了解TCP/IP的主要知识，详细的知识的话《TCP/IP详解》会更加合适。