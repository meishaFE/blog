---
title: ä¸€ä¸ªå¼¹çª—å†…å®¹å¼•å‘çš„"è¡€æ¡ˆ"(ä¸‹)
date: 2019-06-17
tags:
- Vue
- JavaScript
- Component
---

ä¸Šå›è¯´åˆ°é„™äººå·²ç»é€šè¿‡å°è£…å•ä¸ªç»„ä»¶æ–‡ä»¶(`.vue`)çš„æ–¹å¼ç ´è§£äº†è¿™æ¡©"è¡€æ¡ˆ"ã€‚ä½†æ˜¯å´ä¸æ˜¯æœ€"ä¼˜ç¾"çš„è§£å†³æ–¹å¼ï¼Œäºæ˜¯ä¾¿æœ‰äº†æ­¤æ–‡ã€‚

<!-- more -->

# ä¸€ã€åç»­æ€è€ƒ

å‰é¢è¯´åˆ°`$createElement`å¯ä»¥æ¥å—ä¸€ä¸ªç»„ä»¶é€‰é¡¹å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œè€Œä¸”é€šè¿‡`import`ç»„ä»¶çš„æ–¹å¼ä¹ŸæˆåŠŸæ‹¿åˆ°äº†ç›®æ ‡ç»„ä»¶çš„é€‰é¡¹å¯¹è±¡ã€‚é‚£ä¹ˆé™¤äº†è¯¥æ–¹æ³•è¿˜èƒ½ä¸èƒ½é‡‡ç”¨å…¶ä»–æ›´å¥½çš„è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿæ¯”å¦‚ä¸é‡‡ç”¨å°è£…å•ä¸ªç»„ä»¶æ–‡ä»¶çš„æ–¹å¼ï¼Œè€Œæ˜¯ç›´æ¥æ„å»ºä¸€ä¸ªå±€éƒ¨ç»„ä»¶è·å–å®ƒçš„é€‰é¡¹å¯¹è±¡ã€‚

é¦–å…ˆä»‹ç»`Vue`ä¸­æˆ‘æ‰€äº†è§£çš„ä¸¤ç§æ„å»ºç»„ä»¶çš„æ–¹æ³•:

1. `Vue.extend(options)` ä½¿ç”¨åŸºç¡€`Vue`æ„é€ å™¨ï¼Œåˆ›å»ºä¸€ä¸ª"å­ç±»"ã€‚

    ç»“æœè¿”å›ä¸€ä¸ªç»„ä»¶æ„é€ å™¨ã€‚å…·ä½“ğŸŒ°ä»£ç å¦‚ä¸‹:

    ```javascript
    // è·å–æ„é€ å™¨
    let myCom = Vue.extend({
      template: '<p>ä¹é˜Ÿçš„å¤å¤©</p>',
      data () {
        return {
          bandArr: ['é¢å­”', 'ç—›ä»°', 'ä¹è¿çœŸäºº']
        };
      }
      // ...
    });
    // å®ä¾‹åŒ–
    let vm = new myCom();
    ```

2. `Vue.component(id, [definition])` æ³¨å†Œæˆ–è·å–å…¨å±€ç»„ä»¶ã€‚

    ç»“æœåŒæ ·è¿”å›ä¸€ä¸ªæ„é€ å™¨ï¼ŒğŸŒ°å¦‚ä¸‹ï¼š

    ```javascript
    // æ³¨å†Œç»„ä»¶
    Vue.component('my-com', {
      template: '<p>ä¹é˜Ÿçš„å¤å¤©</p>',
      data () {
        return {
          bandArr: ['æ–°è£¤å­', 'Mr Woohoo', 'æµ·é¾Ÿå…ˆç”Ÿ']
        };
      }
      // ...
    })
    // è·å–æ³¨å†Œçš„ç»„ä»¶(è¿”å›æ„é€ å™¨éå®ä¾‹)
    let myCom = Vue.component('my-com');
    ```

ç†Ÿæ‚‰`Vue`çš„åŒå­¦åº”è¯¥çŸ¥é“å¦‚æœå•çº¯åªè¦å¾—åˆ°ä¸€ä¸ªæ„é€ å™¨çš„è¯ä½¿ç”¨`Vue.extend`å°±å¤Ÿäº†ï¼Œå› ä¸º`Vue.component`çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯`Vue.extend`çš„è¿”å›å€¼ã€‚(ä¼šéšå¼è°ƒç”¨`Vue.extend`ï¼Œå¦‚æœä½ ä¼ å…¥ä¸€ä¸ªå¯¹è±¡çš„è¯)ã€‚

å¥½ï¼Œé‚£ä¹ˆåˆ°ç›®å‰æ€è·¯å¾ˆæ¸…æ™°äº†ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡`Vue.extend`å¾—åˆ°ç›®æ ‡ç»„ä»¶çš„æ„é€ å‡½æ•°ï¼Œç„¶åé€šè¿‡`new`ã€‚ã€‚ã€‚ä¸€ä¸ªã€‚ã€‚ã€‚å®ä¾‹ï¼Ÿã€‚ã€‚ã€‚ã€‚ã€‚

ç»†å¿ƒçš„åŒå­¦ä¼šå‘ç°æˆ‘åˆæœ¬æœ«å€’ç½®äº†ï¼Œæˆ‘æœ¬æ¥å°±ä¼ å…¥äº†ç»„ä»¶çš„é€‰é¡¹å¯¹è±¡æ¥ç”Ÿæˆæ„é€ å™¨ã€‚æ‰€ä»¥æœ€ç»ˆçš„å®ç°æ–¹å¼æ˜¯è¿™æ ·çš„:

```javascript
const h = this.$createElement;
this.$confirm('', 'æç¤º', {
  message: h({
    name: 'myCom',
    template: '<p>ä¹é˜Ÿçš„å¤å¤©çœŸå¥½çœ‹</p>'
  }),
  closeOnClickModal: false,
  confirmButtonText: 'å‘é€',
  cancelButtonText: 'å–æ¶ˆ'
}).then(() => {
}).catch(() => {
});
```

# äºŒã€çœŸç›¸åªæœ‰ä¸€ä¸ª

çˆ±æŠ˜è…¾çš„æˆ‘è¿˜æ˜¯ä¸æ»¡æ„ç°æœ‰çš„æ–¹å¼ï¼ŒåŸå› æœ‰äºŒ: 1. é‡‡ç”¨å­—ç¬¦ä¸²æ¨¡ç‰ˆçš„æ–¹å¼å¤ªæ­»æ¿ä¸å¤Ÿçµæ´»ï¼›2. å•çº¯åœ°æƒ³æäº‹æƒ…ã€‚

äºæ˜¯æˆ‘åˆæ‰¾å•Šæ‰¾ï¼Œè¯¶ï¼Œæ‰¾åˆ°äº†åŸæ¥é™¤äº†`template`ä¹‹å¤–è¿˜æœ‰`render`ä¸”å®˜ç½‘è¯´åˆ°å¦‚æœ`Vue`é€‰é¡¹ä¸­è‹¥å­˜åœ¨`render`å‡½æ•°åˆ™ä¸ä¼šå†é€šè¿‡`template`æˆ–`el`æŒ‡å®šçš„æŒ‚è½½å…ƒç´ ä¸­æå–å‡ºçš„ HTML æ¨¡æ¿ç¼–è¯‘æ¸²æŸ“å‡½æ•°ã€‚è¯´åˆ°è¿™ä¸ª`render`å‡½æ•°å®ƒæ¥å—æˆ‘ä»¬ä¹‹å‰ä¸€ç›´æœ‰ç”¨åˆ°è¿‡çš„æ–¹å¼(`$createElement`)ä½œä¸ºå‚æ•°æ¥åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹(`VNode`)ã€‚è¿™æœ‰å›åˆ°äº†æ•…äº‹çš„å¼€å¤´ï¼Œå†™å½¢å¦‚è¿™æ ·çš„:

```javascript
// DOMèŠ‚ç‚¹å¯¹è±¡æ ‘
h('p', null, [
  h('span', null, 'å†…å®¹å¯ä»¥æ˜¯ '),
  h('i', { style: 'color: teal' }, 'VNode')
])
```

ä½†åœ¨è¿™é‡Œè¦è¡¥å……çš„æ˜¯å¦‚æœä½ ä¸å–œæ¬¢è¿™ç§å†™æ³•ï¼Œé‚£ä½ å¯ä»¥å†™`JSX`å‘€(æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰è¿™æ®µè¯)ã€‚å°±åƒåœ¨`React`é‡Œé¢é‚£æ ·ï¼Œæ²¡é”™ï¼Œæ˜¯å¯ä»¥çš„ï¼Œåªè¦ä½ å®‰è£…äº†`babel`æ’ä»¶ã€‚

å½“ç„¶è¿™ä¸ªéœ€æ±‚æˆ‘è‚¯å®šæ˜¯ä¸ä¼šç”¨`JSX`å»æ”¹é€ çš„å•¦ï¼Œæœ‰ç‚¹å°é¢˜å¤§åšäº†ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘è¦å¼•å‡ºè¿™ä¸ª`render`å‘¢ï¼Ÿæ˜¯å› ä¸º`Vue.compile`å¯ä»¥ç”Ÿæˆè¿™ä¸ª`render`å‡½æ•°ã€‚å®ƒæ¥å—çš„å‚æ•°å°±æ˜¯å­—ç¬¦ä¸²æ¨¡æ¿ã€‚é‚£ä¹ˆæˆ‘ä»¬è¿™ä¸€æ¬¡çš„æ–¹å¼å˜æˆäº†è¿™æ ·:

```javascript
// æœ€ç»ˆå†™æ³•
let htmlStr = '<p>ä¹é˜Ÿçš„å¤å¤©çœŸå¥½çœ‹å•Š</p>';
let comRender = Vue.compile(htmlStr).render;
let staticRender = Vue.compile(htmlStr).staticRenderFns;
const h = this.$createElement;
this.$confirm('', 'æç¤º', {
  message: h({
    name: 'myCom',
    render: comRender,
    staticRenderFns: staticRender
  }),
  closeOnClickModal: false,
  confirmButtonText: 'å‘é€',
  cancelButtonText: 'å–æ¶ˆ'
}).then(() => {
}).catch(() => {
});
```

å…¶å®è¿™é‡Œå°±ç›¸å½“äºæˆ‘ä»¬ä¸»åŠ¨è°ƒèµ·`Vue`çš„ç¼–è¯‘æµç¨‹ï¼Œå› ä¸ºæˆ‘ä»¬éƒ½çŸ¥é“ä»å­—ç¬¦ä¸²æ¨¡æ¿åˆ°çœŸå®çš„`DOM`æ¸²æŸ“ä¼šç»å†ä¸€ä¸ª`toFunctions`çš„è¿‡ç¨‹ã€‚`Vue.compile`çš„ä½œç”¨å°±æ˜¯èƒ½è®©æˆ‘ä»¬è·å–åˆ°ç¼–è¯‘çš„ç»“æœä¹Ÿå°±æ˜¯`render functions`ã€‚æœ‰ç ”ç©¶è¿‡çš„åŒå­¦åº”è¯¥çŸ¥é“è¿”å›çš„ç»“æœå¯¹è±¡åŒ…å«ä¸¤ä¸ªå±æ€§`render`å’Œ`staticRenderFns`ï¼Œå‰è€…å°±æ˜¯æ™®é€šçš„"æ¸²æŸ“å‡½æ•°"ï¼Œè‡³äºåè€…æ˜¯å•¥ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ç”Ÿæˆçš„`render`å‡½æ•°:

```javascript
function anonymous() {
  with(this) {
    return _c('div', [ // åˆ›å»ºä¸€ä¸ªdivå…ƒç´ 
      _m(0, false, false), // é™æ€èŠ‚ç‚¹ æ­¤å¤„å¯¹åº” staticRenderFns æ•°ç»„ç´¢å¼•ä¸º 0 çš„ render function
      _v(" "), // åˆ›å»ºç©ºæ–‡æœ¬
      _c('el-popover', {
      attrs: {
        "placement": "right-start",
        "width": "245",
        "trigger": "hover"
      }
    },
    [_c('div', {
      staticStyle: {
        "font-size": "12px",
        "color": "#909399"
      }
    },
    [_c('div', [_v("ç»‘å®šæŒ‡çš„æ˜¯å®¶é•¿ç™»å½•ç›¸å…³H5ï¼Œè¾“å…¥æ‰‹æœºå·åŠéªŒè¯ç åå®Œæˆç»‘å®š")]), _v(" "), _c('div', {
      staticStyle: {
        "text-align": "center"
      }
    },
    [_c('img', {
      staticStyle: {
        "width": "60px"
      },
      attrs: {
        "src": "https://cdn.meishakeji.com/",
        "alt": "ç»‘å®šç¤ºæ„å›¾"
      }
    })]), _v(" "), _c('img', {
      staticStyle: {
        "width": "225px"
      },
      attrs: {
        "src": "/static/img/bindPic.6c59ab6.png",
        "alt": "ç»‘å®šç¤ºæ„å›¾"
      }
    })]), _v(" "), _c('span', {
      staticStyle: {
        "font-size": "12px",
        "color": "#909399"
      },
      attrs: {
        "slot": "reference"
      },
      slot: "reference"
    },
    [_c('i', {
      staticClass: "iconfont icon-ic_help",
      staticStyle: {
        "font-size": "14px"
      }
    }), _v(" "), _c('span', [_v("ä»€ä¹ˆæ˜¯ç»‘å®š")])])])], 1)
  }
}
```

çœ‹è¿‡æºç çš„åŒå­¦å¯¹äºä¸Šé¢çš„`_c, _v, _m`åº”è¯¥ä¸é™Œç”Ÿã€‚

```javascript
// Vueæºç 
export function installRenderHelpers (target: any) {
  target._o = markOnce
  target._n = toNumber
  target._s = toString
  target._l = renderList
  target._t = renderSlot
  target._q = looseEqual
  target._i = looseIndexOf
  target._m = renderStatic // æ¸²æŸ“é™æ€èŠ‚ç‚¹
  target._f = resolveFilter
  target._k = checkKeyCodes
  target._b = bindObjectProps
  target._v = createTextVNode // åˆ›å»ºè™šæ‹Ÿæ–‡æœ¬èŠ‚ç‚¹
  target._e = createEmptyVNode
  target._u = resolveScopedSlots
  target._g = bindObjectListeners
  target._d = bindDynamicKeys
  target._p = prependModifier
}
```

`render`å‡½æ•°ä¸­çš„`_m(0, false, false)`å°±æ˜¯è°ƒç”¨`staticRenderFns`æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå‡½æ•°ã€‚è¿™ä¸ªæ•°ç»„ä¸­çš„å‡½æ•°ä¸"è™šæ‹ŸDOM"ä¸­çš„`diff`ç®—æ³•æœ‰å…³ï¼Œä¼šåœ¨ç¼–è¯‘é˜¶æ®µç»™åç»­ä¸ä¼šå‘ç”Ÿå˜åŒ–çš„`VNode`æ‰“ä¸Šstaticçš„ä¸ºtrueçš„keyã€‚ç›®å‰æœ€æ–°çš„`Vue`æºç ä¼šå°†è¿™ç±»`VNode`åŠ å…¥åˆ°ä¸€ä¸ªåä¸º`cached`çš„æ•°ç»„å½“ä¸­ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ä¸Šé¢çš„ğŸŒ°é‡Œæˆ‘è¦åŠ å¤šä¸€ä¸ª`staticRenderFns`å±æ€§ï¼Œä¸ç„¶ä¼šæŠ¥`Cannot read property 'cached' of undefined`ã€‚

# ä¸‰ã€æ€»ç»“

å¥½ï¼Œè¿™å®—"è¡€æ¡ˆ"åˆ°è¿™é‡Œå°±å®Œç¾"ç»“æ¡ˆ"äº†ã€‚æœ¬æ¥è¿˜æƒ³ç€ç»™å¤§å®¶ç®€å•ä»‹ç»ä¸‹`Vueçš„ç»„ä»¶åŒ–`å’Œ`Vueçš„ç¼–è¯‘`éƒ½åˆ°åº•å¹²äº†äº›å•¥ã€‚ä½†æ˜¯å†™èµ·æ¥å‘ç°è‡ªå·±çš„è®¤çŸ¥è¿˜æ˜¯é‚£ä¹ˆçš„æµ…è–„ï¼Œæ‰€ä»¥åœ¨è¿™å°±ä¸"ç­é—¨å¼„æ–§"äº†ï¼Œä¸‹å»æ²‰æ·€ä¸€æ³¢å†æ¥ï¼

***æ³¨:ä½œè€…æ‰ç–å­¦æµ…ï¼Œå¦‚æœ‰ä¸å½“çš„åœ°æ–¹æ¬¢è¿æŒ‡å‡ºï¼***